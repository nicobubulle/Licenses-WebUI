<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Statistics - {{ _('title') }}</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icon-192.png') }}">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    :root{
      --primary:#007bff;
      --danger:#dc3545;
      --muted:#666;
      --card:#f9f9f9;
      --surface:#ffffff;
      --border:#e6e6e6;
      --radius:8px;
    }
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #fafafa; color:#111; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { font-size:1.25rem; margin:0; }
    
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); cursor:pointer; font-weight:600; text-decoration: none; color: #111; }
    .btn img { width:16px; height:16px; display:block; }
    .btn-primary { background: linear-gradient(180deg,var(--primary),#0056d6); color:#fff; border-color:rgba(0,0,0,0.08); }
    
    .card { background:var(--card); border-radius:var(--radius); padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; }
    
    .controls { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .controls label { font-weight: 600; }
    .controls select, .controls input { padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; }
    
    .chart-container { position: relative; height: 400px; margin-bottom: 24px; }
    
    .small { font-size:0.85em; color:var(--muted); }
    
    footer { margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.85em; }
    footer a { color: var(--primary); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div class="title-row">
      <h1 style="display:inline-block; margin:0;">{{ _('stats_title') }}</h1>
      <small style="display:inline-block; margin-left:10px; color:#666; font-size:0.9em;">
        v{{ app_version }}
        {% if update_available %}
          &nbsp;<a href="{{ latest_url }}" target="_blank" style="color:red; font-weight:bold; text-decoration:underline;">Update available: v{{ latest_version }}</a>
        {% endif %}
      </small>
    </div>
    <div class="toolbar">
      <a href="{{ url_for('index') }}" class="btn">‚Üê {{ _('back_to_dashboard') }}</a>
    </div>
  </header>

  <div class="card">
    <div class="controls">
      <div>
        <label for="feature-select">{{ _('feature_label') }}:</label>
        <select id="feature-select">
          <option value="">{{ _('all_features') }}</option>
        </select>
      </div>
      <div>
        <label for="time-range">{{ _('time_range') }}:</label>
        <select id="time-range">
          <option value="1">{{ _('last_hour') }}</option>
          <option value="6">{{ _('last_6_hours') }}</option>
          <option value="24" selected>{{ _('last_24_hours') }}</option>
          <option value="168">{{ _('last_7_days') }}</option>
          <option value="720">{{ _('last_30_days') }}</option>
        </select>
      </div>
      <button id="refresh-chart" class="btn btn-primary" title="{{ _('refresh_title') }}" aria-label="{{ _('refresh_title') }}">
        <img src="{{ url_for('static', filename='refresh.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
        <span>{{ _('refresh_label') }}</span>
      </button>
    </div>
    
    <div class="chart-container">
      <canvas id="usage-chart"></canvas>
    </div>
  </div>

  <footer>
    <p style="margin: 8px 0;">
      <strong>Licenses WebUI</strong> v{{ app_version }}
    </p>
    <p style="margin: 8px 0;">
      &copy; 2025 
      <a href="https://github.com/nicobubulle/Licenses-WebUI" target="_blank" rel="noopener noreferrer">
        nicobubulle/Licenses-WebUI
      </a>
    </p>
  </footer>

<script>
const I18N = {{ i18n_json|safe }};

function t(key, vars){
  const v = I18N[key] || key;
  if(!vars) return v;
  return v.replace(/\{(\w+)\}/g, (_,n)=> (vars[n]!==undefined?vars[n]:''));
}

let chart = null;
let allFeatures = [];

async function fetchStats() {
  const feature = document.getElementById('feature-select').value;
  const hours = document.getElementById('time-range').value;
  
  try {
    const response = await fetch(`/api/stats?hours=${hours}${feature ? '&feature=' + encodeURIComponent(feature) : ''}`);
    const data = await response.json();
    
    if (!data.ok) {
      console.error('Stats API error:', data.error);
      return;
    }
    
    // Get all feature names if not loaded
    if (allFeatures.length === 0) {
      allFeatures = Object.keys(data.features).sort();
      populateFeatureSelect();
    }
    
    renderChart(data.features, feature);
  } catch (e) {
    console.error('Failed to fetch stats:', e);
  }
}

function populateFeatureSelect() {
  const select = document.getElementById('feature-select');
  select.innerHTML = `<option value="">${t('all_features')}</option>`;
  allFeatures.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f;
    opt.textContent = f;
    select.appendChild(opt);
  });
}

function renderChart(featuresData, selectedFeature) {
  const canvas = document.getElementById('usage-chart');
  const ctx = canvas.getContext('2d');
  
  // Destroy existing chart if it exists
  if (chart) {
    chart.destroy();
    chart = null;
  }
  
  const datasets = [];
  const colors = [
    '#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8',
    '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6610f2'
  ];
  
  let colorIndex = 0;
  
  for (const [featureName, points] of Object.entries(featuresData)) {
    if (selectedFeature && featureName !== selectedFeature) continue;
    
    const color = colors[colorIndex % colors.length];
    colorIndex++;
    
    // Create dataset for used licenses
    datasets.push({
      label: `${featureName} (Used)`,
      data: points.map(p => ({
        x: p.timestamp * 1000,
        y: p.used
      })),
      borderColor: color,
      backgroundColor: color + '33',
      fill: false,
      tension: 0.1
    });
    
    // Create dataset for available licenses
    datasets.push({
      label: `${featureName} (Available)`,
      data: points.map(p => ({
        x: p.timestamp * 1000,
        y: p.available
      })),
      borderColor: color,
      backgroundColor: color + '33',
      borderDash: [5, 5],
      fill: false,
      tension: 0.1
    });
  }
  
  chart = new Chart(ctx, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'hour',
            displayFormats: {
              hour: 'MMM d, HH:mm'
            }
          },
          title: {
            display: true,
            text: '{{ _('time') }}'
          },
          min: Date.now() - (parseInt(document.getElementById('time-range').value) * 3600000),
          max: Date.now()
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: '{{ _('license_count') }}'
          },
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      }
    }
  });
}

// Event listeners
document.getElementById('feature-select').addEventListener('change', fetchStats);
document.getElementById('time-range').addEventListener('change', fetchStats);
document.getElementById('refresh-chart').addEventListener('click', fetchStats);

// Initial load
fetchStats();

// Auto-refresh every 5 minutes
setInterval(fetchStats, 5 * 60 * 1000);
</script>
</body>
</html>
