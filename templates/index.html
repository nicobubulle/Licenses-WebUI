<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ _('title') }}</title>

  <!-- Standard favicon (browsers fall back to /favicon.ico) -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

  <!-- PNG favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icon-192.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Apple touch -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">

  <!-- Android / PWA manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

  <!-- Prevent caching during development: ?v=1 (update when icon changes) -->
  <meta name="theme-color" content="#ffffff">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --primary:#007bff;
      --danger:#dc3545;
      --muted:#666;
      --card:#f9f9f9;
      --surface:#ffffff;
      --border:#e6e6e6;
      --radius:8px;
    }
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #fafafa; color:#111; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { font-size:1.25rem; margin:0; }

    /* Toolbar */
    .toolbar { display:flex; gap:8px; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); cursor:pointer; font-weight:600; }
    .btn svg, .btn img { width:16px; height:16px; display:block; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-primary { background: linear-gradient(180deg,var(--primary),#0056d6); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-danger { background: linear-gradient(180deg,var(--danger),#b02a37); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); font-weight:500; }

    /* Spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.9);
      animation:spin 1s linear infinite; display:inline-block;
    }
    .spinner-dark {
      border:2px solid rgba(0,0,0,0.12); border-top-color:rgba(0,0,0,0.6);
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .small { font-size: 0.9em; color: var(--muted); }
    .error { color: red; white-space: pre-wrap; margin-top:8px; }

    /* Card / table */
    .card { background:var(--card); padding:12px; border-radius:var(--radius); border:1px solid var(--border); }
    table { border-collapse: collapse; width: 100%; background:var(--surface); border-radius:6px; overflow:hidden; }
    th, td { border-bottom:1px solid var(--border); padding:10px; vertical-align:top; text-align:left; }
    th { background:#fbfbfb; font-weight:700; font-size:0.95em; }
    .users { font-size: 0.95em; color: #111; }
    .user-line { margin-bottom: 6px; }
    .toast { position:fixed; right:12px; bottom:12px; background:#222; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:none; max-width:320px; white-space:pre-wrap; }

    /* service message box */
    .service-msg {
      position:relative;
      white-space:pre-wrap;
      margin: 12px 0;
      padding:10px 12px;
      border:1px solid #ccc;
      background:#fff;
      border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,0.04);
    }
    .service-close {
      position:absolute;
      right:8px;
      top:6px;
      border:0;
      background:transparent;
      color:#666;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      padding:4px;
    }

    /* Feature groups */
    .group-header {
      background: linear-gradient(180deg, #f0f0f0, #e8e8e8);
      cursor: pointer;
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      user-select: none;
      transition: background 0.2s;
    }
    .group-header-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
    }
    .group-header:hover {
      background: linear-gradient(180deg, #e8e8e8, #e0e0e0);
    }
    .group-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }
    .group-toggle {
      margin-left: auto;
      transition: transform 0.2s;
      font-size: 0.8em;
    }
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    .group-content {
      display: table-row;
    }
    .group-content.collapsed {
      display: none;
    }

    @media (max-width:720px){
      header { flex-direction:column; align-items:stretch; gap:10px; }
      .toolbar { justify-content:flex-start; flex-wrap:wrap; }
      th, td { font-size:0.9em; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title-row">
      <h1 style="display:inline-block; margin:0;">{{ _('title') }}</h1>
      <small style="display:inline-block; margin-left:10px; color:#666; font-size:0.9em;">
        v{{ app_version }}
        {% if update_available %}
          &nbsp;<a href="{{ latest_url }}" target="_blank" style="color:red; font-weight:bold; text-decoration:underline;">{{ _('update_available', version=latest_version) }}</a>
        {% endif %}
      </small>
    </div>
    <div class="toolbar">
      <div class="small">{{ _('auto_refresh', minutes=refresh_minutes) }}</div>

      <button id="btn-refresh" class="btn btn-primary" title="{{ _('refresh_title') }}" aria-label="{{ _('refresh_title') }}">
        <img src="{{ url_for('static', filename='refresh.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
        <span id="btn-refresh-label">{{ _('refresh_label') }}</span>
      </button>

      {% if show_restart %}
      <button id="btn-restart" class="btn btn-danger" title="{{ _('restart_title') }}" aria-label="{{ _('restart_title') }}">
        <img src="{{ url_for('static', filename='restart.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
        {{ _('restart_label') }}
      </button>
      {% endif %}

      <a href="{{ url_for('stats') }}" class="btn btn-ghost" title="{{ _('view_statistics') }}" aria-label="{{ _('view_statistics') }}">
        <img src="{{ url_for('static', filename='graph.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
        <span>{{ _('statistics') }}</span>
      </a>
    </div>
  </header>

  <div class="card" style="margin-bottom:12px;">
    <div id="last" class="small"></div>
    <div id="error" class="error"></div>
  </div>

  <div class="card">
    <table id="lic-table" aria-live="polite">
      <thead>
        <tr>
          <th>{{ _('product') }}</th>
          <th>{{ _('usage') }}</th>
          <th>{{ _('users_connected') }}</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="3">{{ _('loading') }}</td></tr>
      </tbody>
    </table>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer style="margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.85em;">
    <p style="margin: 8px 0;">
      <strong>Licenses WebUI</strong> v{{ app_version }}
      {% if update_available %}
        — <a href="{{ latest_url }}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">{{ _('update_available', version=latest_version) }}</a>
      {% endif %}
    </p>
    <p style="margin: 8px 0;">
      &copy; 2025 
      <a href="https://github.com/nicobubulle/Licenses-WebUI" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">
        nicobubulle/Licenses-WebUI
      </a>
    </p>
    <p style="margin: 8px 0;">
      {{ _('footer_license') }} — 
      <a href="https://github.com/nicobubulle/Licenses-WebUI/blob/main/README.md" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">{{ _('footer_docs') }}</a>
      {% if show_restart %}
        — {{ _('footer_admin_mode') }}
      {% endif %}
    </p>
    <p style="margin: 12px 0 8px 0;">
      <a href="https://buymeacoffee.com/nbullier" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 36px; width: auto; border-radius: 6px;">
      </a>
    </p>
  </footer>

<script>
const REFRESH_MS = {{ refresh_minutes|tojson }} * 60 * 1000;
const I18N = {{ i18n_json|safe }};
const FEATURE_GROUPS = {{ feature_groups_json|safe }};

// Build feature-to-group mapping (exact + wildcard "*")
const exactFeatureToGroup = {};
const wildcardPatterns = [];
if (FEATURE_GROUPS.groups) {
  FEATURE_GROUPS.groups.forEach(g => {
    if (g.features) {
      g.features.forEach(f => {
        const fl = String(f).toLowerCase();
        if (fl.includes('*')) {
          // Store wildcard pattern for later matching
          wildcardPatterns.push({ pattern: fl, groupId: g.id });
        } else {
          exactFeatureToGroup[fl] = g.id;
        }
      });
    }
  });
}

// Track collapsed state: start collapsed by default
const collapsedGroups = new Set((FEATURE_GROUPS.groups || []).map(g => g.id).concat(['other']));

function t(key, vars){
  const v = I18N[key] || key;
  if(!vars) return v;
  return v.replace(/\{(\w+)\}/g, (_,n)=> (vars[n]!==undefined?vars[n]:''));
}

const statusUrl = "/status";
const refreshUrl = "/refresh";
const restartUrl = "/restart";

const btnRefresh = document.getElementById("btn-refresh");
const btnRefreshLabel = document.getElementById("btn-refresh-label");
const btnRestart = document.getElementById("btn-restart");
const toast = document.getElementById("toast");

let refreshing = false;

function showToast(text, timeout=4000){
  toast.textContent = text;
  toast.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.style.display = "none", timeout);
}

function toggleGroup(groupId) {
  const rows = document.querySelectorAll(`.group-${groupId}`);
  const toggle = document.getElementById(`group-toggle-${groupId}`);
  const isCollapsed = collapsedGroups.has(groupId);
  if (isCollapsed) {
    collapsedGroups.delete(groupId);
    rows.forEach(r => r.classList.remove('collapsed'));
    if (toggle) toggle.classList.remove('collapsed');
  } else {
    collapsedGroups.add(groupId);
    rows.forEach(r => r.classList.add('collapsed'));
    if (toggle) toggle.classList.add('collapsed');
  }
}

function getGroupForFeature(featureName) {
  const lname = String(featureName).toLowerCase();
  // Exact match first
  if (exactFeatureToGroup[lname]) {
    return exactFeatureToGroup[lname];
  }
  // Wildcard match: * can appear anywhere, matches any chars
  for (const { pattern, groupId } of wildcardPatterns) {
    const regex = new RegExp('^' + pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*') + '$');
    if (regex.test(lname)) {
      return groupId;
    }
  }
  return 'other';
}

async function fetchStatus(){
  try {
    const r = await fetch(statusUrl);
    const data = await r.json();
    const tbody = document.getElementById("tbody");
    const lastDiv = document.getElementById("last");
    const errDiv = document.getElementById("error");
    errDiv.textContent = "";

    if (!data.ok) {
      tbody.innerHTML = `<tr><td colspan='4'>${t('fetch_error')}</td></tr>`;
      errDiv.textContent = data.error || t('fetch_error');
      lastDiv.textContent = t('last_attempt', {when: (data.last_update ? new Date(data.last_update*1000).toLocaleString() : "—")});
      return;
    }

    const licenses = data.licenses || {};
    
    // Group licenses
    const grouped = {};
    FEATURE_GROUPS.groups.forEach(g => {
      grouped[g.id] = { group: g, features: [] };
    });
    grouped['other'] = { group: FEATURE_GROUPS.other || {title: 'Other', icon: 'static/icons/other.png'}, features: [] };

    Object.keys(licenses).sort().forEach(name => {
      const groupId = getGroupForFeature(name);
      if (grouped[groupId]) {
        grouped[groupId].features.push({name, data: licenses[name]});
      } else {
        grouped['other'].features.push({name, data: licenses[name]});
      }
    });

    let html = "";
    const allGroupIds = [...FEATURE_GROUPS.groups.map(g => g.id), 'other'];
    
    if (Object.keys(licenses).length === 0) {
      html = `<tr><td colspan='4'>${t('no_licenses')}</td></tr>`;
    } else {
      for (const groupId of allGroupIds) {
        const groupData = grouped[groupId];
        if (!groupData || groupData.features.length === 0) continue;
        
        const grp = groupData.group;
        const isCollapsed = collapsedGroups.has(groupId);
        
        html += `<tr class="group-header" onclick="toggleGroup('${groupId}')">
                  <td colspan="3">
                    <div class="group-header-content">
                      <img src="${grp.icon || 'static/icons/other.png'}" class="group-icon" alt="${grp.title}" />
                      <span>${grp.title || groupId}</span>
                      <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}" id="group-toggle-${groupId}">▼</span>
                    </div>
                  </td>
                </tr>`;
        
        for (const {name, data: item} of groupData.features) {
          const total = (item.total === null || item.total === undefined) ? "?" : item.total;
          const used = (item.used === null || item.used === undefined) ? (item.users ? item.users.length : 0) : item.used;
          const usage = `${used}/${total}`;
          const expiry = item.expiry || "";
          let usersHtml = "";
          if (item.users && item.users.length>0) {
            for (const u of item.users) {
              usersHtml += `<div class="user-line">${u.user} @ ${u.computer} — v${u.version} — ${u.start}</div>`;
            }
          } else {
            usersHtml = `<div class='small'>${t('no_users')}</div>`;
          }

          html += `<tr class="group-content group-${groupId} ${isCollapsed ? 'collapsed' : ''}">
                    <td><strong>${name}</strong></td>
                    <td>${usage}</td>
                    <td class="users">${usersHtml}</td>
                  </tr>`;
        }
        
      }
    }

    tbody.innerHTML = html;
    lastDiv.textContent = t('last_update', {when: new Date(data.last_update*1000).toLocaleString()});
  } catch (e) {
    document.getElementById("tbody").innerHTML = `<tr><td colspan='4'>${t('fetch_error')}</td></tr>`;
     document.getElementById("error").textContent = e.toString();
  }
}

async function doRefresh(){
  if(refreshing) return;
  refreshing = true;
  btnRefresh.disabled = true;
  btnRefreshLabel.textContent = t('loading');
  try{
    const r = await fetch(refreshUrl, {method: 'POST'});
    if(r.ok){
      showToast(t('refresh_done'));
      await fetchStatus();
    } else {
      showToast(t('refresh_error', {err: 'HTTP ' + r.status}));
    }
  } catch(e){
    showToast(t('fetch_error'));
  } finally{
    refreshing = false;
    btnRefresh.disabled = false;
    btnRefreshLabel.textContent = t('refresh_label');
  }
}

async function doRestart(){
  if(!confirm(t('confirm_restart'))) return;
  if(btnRestart) btnRestart.disabled = true;
  try{
    const r = await fetch(restartUrl, {method: 'POST'});
    const payload = await r.json().catch(()=>null);
    if(r.ok && payload && payload.status === "ok"){
      showToast(t('restart_success'));
      // no auto-refresh or service-msg UI; user can manual refresh
    } else {
      let msg = (payload && payload.message) ? payload.message : ('HTTP ' + r.status);
      showToast(t('restart_error', {err: msg}));
    }
  } catch(e){
    showToast(t('fetch_error'));
  } finally{
    if(btnRestart) btnRestart.disabled = false;
  }
}

btnRefresh.addEventListener("click", doRefresh);
if(btnRestart) btnRestart.addEventListener("click", doRestart);

// initial
fetchStatus();
// auto refresh
setInterval(fetchStatus, REFRESH_MS);
</script>
</body>
</html>
