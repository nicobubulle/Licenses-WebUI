<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ _('title') }}</title>

  <!-- Standard favicon (browsers fall back to /favicon.ico) -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

  <!-- PNG favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icon-192.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Apple touch -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">

  <!-- Android / PWA manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

  <!-- Prevent caching during development: ?v=1 (update when icon changes) -->
  <meta name="theme-color" content="#ffffff">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --primary:#007bff;
      --danger:#dc3545;
      --muted:#666;
      --card:#f9f9f9;
      --surface:#ffffff;
      --border:#e6e6e6;
      --radius:8px;
    }
    body { font-family: Arial, Helvetica, sans-serif; margin: 20px; background: #fafafa; color:#111; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { font-size:1.25rem; margin:0; }

    /* Toolbar */
    .toolbar { display:flex; gap:8px; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; border:1px solid var(--border); background:var(--surface); cursor:pointer; font-weight:600; }
    .btn svg, .btn img { width:16px; height:16px; display:block; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-primary { background: linear-gradient(180deg,var(--primary),#0056d6); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-danger { background: linear-gradient(180deg,var(--danger),#b02a37); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); font-weight:500; }
    .btn-stats { background: linear-gradient(180deg,#6f42c1,#5a32a3); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-stats img { filter: brightness(0) invert(1); }
    .btn-eid { background: linear-gradient(180deg,#20c997,#148f6f); color:#fff; border-color:rgba(0,0,0,0.08); }
    .btn-eid img { filter: brightness(0) invert(1); }

    /* Spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.25); border-top-color:rgba(255,255,255,0.9);
      animation:spin 1s linear infinite; display:inline-block;
    }
    .spinner-dark {
      border:2px solid rgba(0,0,0,0.12); border-top-color:rgba(0,0,0,0.6);
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .small { font-size: 0.9em; color: var(--muted); }
    .error { color: red; white-space: pre-wrap; margin-top:8px; }

    /* Card / table */
    .card { background:var(--card); padding:12px; border-radius:var(--radius); border:1px solid var(--border); }
    table { border-collapse: collapse; width: 100%; background:var(--surface); border-radius:6px; overflow:hidden; }
    th, td { border-bottom:1px solid var(--border); padding:10px; vertical-align:top; text-align:left; }
    th { background:#fbfbfb; font-weight:700; font-size:0.95em; }
    .users { font-size: 0.95em; color: #111; }
    .user-line { margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .maint-icon { font-size: 1em; line-height: 1; }
    .maint-none { color: #888; } /* ‚ö´ Multiple features without maintenance */
    .maint-ok { color: #28a745; } /* üü¢ Both standard and maintenance */
    .maint-no-maintenance { color: #fd7e14; } /* üü† Only standard */
    .maint-no-standard { color: #dc3545; } /* üî¥ Only maintenance */
    
    /* Version date coloring */
    .version-future { color: #28a745; font-weight: 600; } /* Green: future version */
    .version-recent { color: #fd7e14; font-weight: 600; } /* Orange: recent but outdated */
    .version-old { color: #dc3545; font-weight: 600; } /* Red: old version */
    
    .toast { position:fixed; right:12px; bottom:12px; background:#222; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:none; max-width:320px; white-space:pre-wrap; }

    /* service message box */
    .service-msg {
      position:relative;
      white-space:pre-wrap;
      margin: 12px 0;
      padding:10px 12px;
      border:1px solid #ccc;
      background:#fff;
      border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,0.04);
    }
    .service-close {
      position:absolute;
      right:8px;
      top:6px;
      border:0;
      background:transparent;
      color:#666;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      padding:4px;
    }

    /* Feature groups */
    .group-header {
      background: linear-gradient(180deg, #f0f0f0, #e8e8e8);
      cursor: pointer;
      font-weight: 700;
      border-bottom: 2px solid var(--border);
      user-select: none;
      transition: background 0.2s;
    }
    .group-header-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      position: relative;
    }
    .group-header:hover {
      background: linear-gradient(180deg, #e8e8e8, #e0e0e0);
    }
    .group-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }
    .group-toggle {
      margin-left: auto;
      transition: transform 0.2s;
      font-size: 0.8em;
    }
    .group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    .group-content {
      display: table-row;
    }
    .group-content.collapsed {
      display: none;
    }
    
    /* EID display */
    .eid-count {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9em;
      color: var(--muted);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .eid-info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0078d4, #005a9e);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.2);
      line-height: 1;
      padding-bottom: 1px;
    }
    .eid-info-icon:hover {
      background: linear-gradient(135deg, #005a9e, #004578);
      box-shadow: 0 3px 8px rgba(0, 120, 212, 0.5);
      transform: scale(1.1);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 12px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
    }
    .modal-close {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      color: #000;
    }
    .eid-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .eid-list li {
      padding: 8px;
      margin: 4px 0;
      background: var(--card);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.95em;
    }

    @media (max-width:720px){
      header { flex-direction:column; align-items:stretch; gap:10px; }
      .toolbar { justify-content:flex-start; flex-wrap:wrap; }
      th, td { font-size:0.9em; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title-row">
      <h1 style="display:inline-block; margin:0;">{{ _('title') }}</h1>
      <small style="display:inline-block; margin-left:10px; color:#666; font-size:0.9em;">
        v{{ app_version }}
        {% if update_available %}
          &nbsp;<a href="{{ latest_url }}" target="_blank" style="color:red; font-weight:bold; text-decoration:underline;">{{ _('update_available', version=latest_version) }}</a>
        {% endif %}
      </small>
    </div>
    <div class="toolbar">
      <div class="small">{{ _('auto_refresh', minutes=refresh_minutes) }}</div>

      <button id="btn-refresh" class="btn btn-primary" title="{{ _('refresh_title') }}" aria-label="{{ _('refresh_title') }}">
      <img src="{{ url_for('static', filename='refresh.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
      <span id="btn-refresh-label">{{ _('refresh_label') }}</span>
      </button>

      {% if show_restart %}
        {% if not admin_restriction_restart or admin_mode %}
      <button id="btn-restart" class="btn btn-danger" title="{{ _('restart_title') }}" aria-label="{{ _('restart_title') }}">
      <img src="{{ url_for('static', filename='restart.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
      <span>{{ _('restart_label') }}</span>
      </button>
        {% endif %}
      {% endif %}

      {% if admin_mode %}
      <button id="btn-eids" class="btn btn-eid" title="{{ _('eid_overview_title') }}" aria-label="{{ _('eid_overview_title') }}">
      <img src="{{ url_for('static', filename='key.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
      <span>EIDs</span>
      </button>
      {% endif %}
      
      <button id="btn-stats" class="btn btn-stats" title="{{ _('view_statistics') }}" aria-label="{{ _('view_statistics') }}">
      <img src="{{ url_for('static', filename='graph.svg') }}" alt="" width="16" height="16" aria-hidden="true" focusable="false">
      <span>{{ _('statistics') }}</span>
      </button>
    </div>
  </header>

  <div class="card" style="margin-bottom:12px;">
    <div id="last" class="small"></div>
    <div id="error" class="error"></div>
  </div>

  <div class="card">
    <table id="lic-table" aria-live="polite">
      <thead>
        <tr>
          <th>{{ _('product') }}</th>
          <th>{{ _('usage') }}</th>
          <th>{{ _('license_versions') }}</th>
          <th>{{ _('users_connected') }}</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">{{ _('loading') }}</td></tr>
      </tbody>
    </table>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- EID Modal -->
  <div id="eid-modal" class="modal" onclick="if(event.target===this) closeEidModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="eid-modal-title">EID List</h2>
        <button class="modal-close" onclick="closeEidModal()" aria-label="{{ _('close') }}">&times;</button>
      </div>
      <ul id="eid-modal-list" class="eid-list"></ul>
    </div>
  </div>

  <footer style="margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.85em;">
    <p style="margin: 8px 0;">
      <button id="btn-refresh-eid" class="btn btn-ghost" style="font-size: 0.9em;">
        <span id="btn-refresh-eid-label">{{ _('refresh_eid_label') }}</span>
      </button>
    </p>
    <p style="margin: 8px 0;">
      <strong>Licenses WebUI</strong> v{{ app_version }}
      {% if update_available %}
        ‚Äî <a href="{{ latest_url }}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">{{ _('update_available', version=latest_version) }}</a>
      {% endif %}
    </p>
    <p style="margin: 8px 0;">
      &copy; 2025 
      <a href="https://github.com/nicobubulle/Licenses-WebUI" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">
        nicobubulle/Licenses-WebUI
      </a>
    </p>
    <p style="margin: 8px 0;">
      {{ _('footer_license') }} ‚Äî 
      <a href="https://github.com/nicobubulle/Licenses-WebUI/blob/main/README.md" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none;">{{ _('footer_docs') }}</a>
      {% if admin_mode %}
        ‚Äî App admin mode
      {% endif %}
    </p>
    <p style="margin: 12px 0 8px 0;">
      <a href="https://buymeacoffee.com/nbullier" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 36px; width: auto; border-radius: 6px;">
      </a>
    </p>
  </footer>

<script>
const REFRESH_MS = {{ refresh_minutes|tojson }} * 60 * 1000;
const I18N = {{ i18n_json|safe }};
const FEATURE_GROUPS = {{ feature_groups_json|safe }};

// Build feature-to-group mapping (exact + wildcard "*")
const exactFeatureToGroup = {};
const wildcardPatterns = [];
if (FEATURE_GROUPS.groups) {
  FEATURE_GROUPS.groups.forEach(g => {
    if (g.features) {
      g.features.forEach(f => {
        const fl = String(f).toLowerCase();
        if (fl.includes('*')) {
          // Store wildcard pattern for later matching
          wildcardPatterns.push({ pattern: fl, groupId: g.id });
        } else {
          exactFeatureToGroup[fl] = g.id;
        }
      });
    }
  });
}

// Track collapsed state: start collapsed by default
const collapsedGroups = new Set((FEATURE_GROUPS.groups || []).map(g => g.id).concat(['other']));

function t(key, vars){
  const v = I18N[key] || key;
  if(!vars) return v;
  return v.replace(/\{(\w+)\}/g, (_,n)=> (vars[n]!==undefined?vars[n]:''));
}

const statusUrl = "/status";
const refreshUrl = "/refresh";
const restartUrl = "/restart";
const refreshEidUrl = "/refresh-eid";
const refreshLicenseVersionsUrl = "/refresh-license-versions";

const btnRefresh = document.getElementById("btn-refresh");
const btnRefreshLabel = document.getElementById("btn-refresh-label");
const btnRestart = document.getElementById("btn-restart");
const btnRefreshEid = document.getElementById("btn-refresh-eid");
const btnRefreshEidLabel = document.getElementById("btn-refresh-eid-label");
const btnEids = document.getElementById("btn-eids");
const btnStats = document.getElementById("btn-stats");
const toast = document.getElementById("toast");

let refreshing = false;
let refreshingEid = false;

// Navigation handlers
if (btnEids) {
  btnEids.addEventListener("click", () => window.location.href = "{{ url_for('eids_page') }}");
}
if (btnStats) {
  btnStats.addEventListener("click", () => window.location.href = "{{ url_for('stats') }}");
}

function showToast(text, timeout=4000){
  toast.textContent = text;
  toast.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.style.display = "none", timeout);
}

function toggleGroup(groupId) {
  const rows = document.querySelectorAll(`.group-${groupId}`);
  const toggle = document.getElementById(`group-toggle-${groupId}`);
  const isCollapsed = collapsedGroups.has(groupId);
  if (isCollapsed) {
    collapsedGroups.delete(groupId);
    rows.forEach(r => r.classList.remove('collapsed'));
    if (toggle) toggle.classList.remove('collapsed');
  } else {
    collapsedGroups.add(groupId);
    rows.forEach(r => r.classList.add('collapsed'));
    if (toggle) toggle.classList.add('collapsed');
  }
}

function showEidModal(groupTitle, eidListStr) {
  const modal = document.getElementById('eid-modal');
  const title = document.getElementById('eid-modal-title');
  const list = document.getElementById('eid-modal-list');
  
  title.textContent = `${groupTitle} - EID List`;
  
  const eids = eidListStr.split(', ').filter(e => e.trim());
  list.innerHTML = eids.map(eid => `<li>${eid}</li>`).join('');
  
  modal.classList.add('show');
}

function closeEidModal() {
  const modal = document.getElementById('eid-modal');
  modal.classList.remove('show');
}

function getGroupForFeature(featureName) {
  const lname = String(featureName).toLowerCase();
  // Exact match first
  if (exactFeatureToGroup[lname]) {
    return exactFeatureToGroup[lname];
  }
  // Wildcard match: * can appear anywhere, matches any chars
  for (const { pattern, groupId } of wildcardPatterns) {
    const regex = new RegExp('^' + pattern.replace(/[.+?^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*') + '$');
    if (regex.test(lname)) {
      return groupId;
    }
  }
  return 'other';
}

// Parse version string (vYYYY.MMDD) to Date object
function parseVersionDate(versionStr) {
  // Remove 'v' prefix if present
  const cleaned = versionStr.replace(/^v/, '');
  
  // Try format: YYYY.MMDD (e.g., 2022.0616 = 2022-06-16)
  const match = cleaned.match(/^(\d{4})\.(\d{2})(\d{2})$/);
  if (match) {
    const year = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    const day = parseInt(match[3], 10);
    return new Date(year, month - 1, day); // month is 0-indexed
  }
  
  return null;
}

// Get version color and tooltip based on release dates
function getVersionColorInfo(versionStr, groupReleases) {
  const versionDate = parseVersionDate(versionStr);
  if (!versionDate || !groupReleases || groupReleases.length === 0) {
    return { class: '', tooltip: '' };
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Sort releases by date (newest first)
  const sortedReleases = groupReleases.slice().sort((a, b) => {
    return new Date(b.date) - new Date(a.date);
  });
  
  const latestRelease = sortedReleases[0];
  const latestDate = new Date(latestRelease.date);
  latestDate.setHours(0, 0, 0, 0);
  
  // Rule 1: Version date is in the future
  if (versionDate > today) {
    return {
      class: 'version-future',
      tooltip: t('latest_release', {version: latestRelease.app_version, date: latestRelease.date})
    };
  }
  
  // Rule 2: Version date is after latest release date (recent but outdated)
  if (versionDate > latestDate) {
    return {
      class: 'version-recent',
      tooltip: t('latest_release', {version: latestRelease.app_version, date: latestRelease.date})
    };
  }
  
  // Rule 3: Version date is before or equal to latest release
  // Find the last release that is >= version date
  let matchingRelease = null;
  for (const release of sortedReleases) {
    const releaseDate = new Date(release.date);
    releaseDate.setHours(0, 0, 0, 0);
    if (releaseDate <= versionDate) {
      matchingRelease = release;
      break;
    }
  }
  
  if (matchingRelease) {
    return {
      class: 'version-old',
      tooltip: t('last_compatible_release', {version: matchingRelease.app_version, date: matchingRelease.date})
    };
  }
  
  // Fallback: version is older than all releases
  return {
    class: 'version-old',
    tooltip: t('latest_release', {version: latestRelease.app_version, date: latestRelease.date})
  };
}

async function fetchStatus(){
  try {
    const r = await fetch(statusUrl);
    const data = await r.json();
    const tbody = document.getElementById("tbody");
    const lastDiv = document.getElementById("last");
    const errDiv = document.getElementById("error");
    errDiv.textContent = "";

    if (!data.ok) {
      tbody.innerHTML = `<tr><td colspan='4'>${t('fetch_error')}</td></tr>`;
      errDiv.textContent = data.error || t('fetch_error');
      lastDiv.textContent = t('last_attempt', {when: (data.last_update ? new Date(data.last_update*1000).toLocaleString() : "‚Äî")});
      return;
    }

    const licenses = data.licenses || {};
    const eidInfo = data.eid_info || {};
    
    // Group licenses
    const grouped = {};
    FEATURE_GROUPS.groups.forEach(g => {
      const grp = { ...g };
      if (grp.check_maint === undefined) grp.check_maint = true;
      grouped[g.id] = { group: grp, features: [], eids: new Set() };
    });
    const otherGroup = FEATURE_GROUPS.other || {title: 'Other', icon: 'static/icons/other.png'};
    if (otherGroup.check_maint === undefined) otherGroup.check_maint = true;
    grouped['other'] = { group: otherGroup, features: [], eids: new Set() };

    Object.keys(licenses).sort().forEach(name => {
      const groupId = getGroupForFeature(name);
      if (grouped[groupId]) {
        grouped[groupId].features.push({name, data: licenses[name]});
        // Add EIDs for this feature to the group's EID set
        if (eidInfo[name]) {
          eidInfo[name].forEach(eid => grouped[groupId].eids.add(eid));
        }
      } else {
        grouped['other'].features.push({name, data: licenses[name]});
        if (eidInfo[name]) {
          eidInfo[name].forEach(eid => grouped['other'].eids.add(eid));
        }
      }
    });

    let html = "";
    const allGroupIds = [...FEATURE_GROUPS.groups.map(g => g.id), 'other'];
    
    if (Object.keys(licenses).length === 0) {
      html = `<tr><td colspan='4'>${t('no_licenses')}</td></tr>`;
    } else {
      for (const groupId of allGroupIds) {
        const groupData = grouped[groupId];
        if (!groupData || groupData.features.length === 0) continue;
        
        const grp = groupData.group;
        const isCollapsed = collapsedGroups.has(groupId);
        const eidCount = groupData.eids.size;
        const eidList = Array.from(groupData.eids).sort().join(', ');
        const canShowEidButton = {{ (admin_mode or show_eid_info)|tojson }};
        const eidInfoBtnHtml = canShowEidButton ? `<span class="eid-info-icon" onclick="event.stopPropagation(); showEidModal('${grp.title}', '${eidList}')" title="${t('view_eids')}">‚ìò</span>` : '';
        const eidDisplay = groupId !== 'other' && eidCount > 0 ? `<span class="eid-count">${eidCount} EID ${eidInfoBtnHtml}</span>` : '';
        
        html += `<tr class="group-header" onclick="toggleGroup('${groupId}')">
                  <td colspan="4">
                    <div class="group-header-content">
                      <img src="${grp.icon || 'static/icons/other.png'}" class="group-icon" alt="${grp.title}" />
                      <span>${grp.title || groupId}</span>
                      ${eidDisplay}
                      <span class="group-toggle ${isCollapsed ? 'collapsed' : ''}" id="group-toggle-${groupId}">‚ñº</span>
                    </div>
                  </td>
                </tr>`;
        
        for (const {name, data: item} of groupData.features) {
          const total = (item.total === null || item.total === undefined) ? "?" : item.total;
          const used = (item.used === null || item.used === undefined) ? (item.users ? item.users.length : 0) : item.used;
          const usage = `${used}/${total}`;
          const expiry = item.expiry || "";
          
          const maintCheckEnabled = grp && grp.check_maint !== false;

          // Build versions HTML
          let versionsHtml = '';
          const featureVersions = data.license_versions && data.license_versions[name];
          if (featureVersions && Object.keys(featureVersions).length > 0) {
            const versionLines = [];
            const groupReleases = grp.releases || [];
            for (const [version, qty] of Object.entries(featureVersions).sort()) {
              const colorInfo = getVersionColorInfo(version, groupReleases);
              const classAttr = colorInfo.class ? ` class="${colorInfo.class}"` : '';
              const titleAttr = colorInfo.tooltip ? ` title="${colorInfo.tooltip}"` : '';
              versionLines.push(`<span${classAttr}${titleAttr}>v${version}: ${qty}</span>`);
            }
            versionsHtml = versionLines.join('<br>');
          } else {
            versionsHtml = '<span class="small">-</span>';
          }
          
          let usersHtml = "";
          if (item.users && item.users.length>0) {
            // Group users by effective feature_version (use maintenance_version if ok_different)
            const usersByVersion = {};
            for (const u of item.users) {
              // Determine effective version: maintenance if ok_different, otherwise feature_version
              let effectiveVersion = u.feature_version || 'unknown';
              if (u.maintenance_status === 'ok_different' && u.maintenance_version) {
                effectiveVersion = u.maintenance_version;
              }
              
              if (!usersByVersion[effectiveVersion]) {
                usersByVersion[effectiveVersion] = [];
              }
              usersByVersion[effectiveVersion].push(u);
            }
            
            // Sort versions (ascending order, unknown last)
            const sortedVersions = Object.keys(usersByVersion).sort((a, b) => {
              if (a === 'unknown') return 1;
              if (b === 'unknown') return -1;
              return a.localeCompare(b);
            });
            
            // Build HTML grouped by version
            for (const fv of sortedVersions) {
              const users = usersByVersion[fv];
              const groupReleases = grp.releases || [];
              
              const colorInfo = getVersionColorInfo(fv, groupReleases);
              const versionClassAttr = colorInfo.class ? ` class="${colorInfo.class}"` : '';
              const versionTitleAttr = colorInfo.tooltip ? ` title="${colorInfo.tooltip}"` : '';
              
              // Version header
              const suffix = users.length > 1 ? (I18N['users_count_suffix'] || 's') : '';
              usersHtml += `<div style="margin-top: 8px; margin-bottom: 4px; font-weight: 600;"><span${versionClassAttr}${versionTitleAttr}>üîë v${fv}</span> (${t('users_count', {n: users.length, suffix})})</div>`;
              
              // Users in this version
              for (const u of users) {
                // Check if user is duplicate
                const isDuplicate = u.is_duplicate || false;
                
                // Determine maintenance status icon (or duplicate warning)
                let maintIcon = '';
                let maintClass = '';
                let maintTooltip = '';
                
                if (isDuplicate) {
                  // Override with duplicate warning
                  maintIcon = '‚ö†Ô∏è';
                  maintClass = 'maint-duplicate';
                  maintTooltip = t('duplicate_warning') || 'Duplicate checkout detected';
                } else if (!maintCheckEnabled) {
                  // Maintenance consistency disabled for this group: always show neutral black icon
                  maintIcon = '‚ö´';
                  maintClass = 'maint-none';
                  maintTooltip = t('maint_none');
                } else if (u.maintenance_status === 'none') {
                  maintIcon = '‚ö´';
                  maintClass = 'maint-none';
                  maintTooltip = t('maint_none');
                } else if (u.maintenance_status === 'ok') {
                  maintIcon = 'üü¢';
                  maintClass = 'maint-ok';
                  maintTooltip = t('maint_ok');
                } else if (u.maintenance_status === 'ok_different') {
                  maintIcon = 'üü¢';
                  maintClass = 'maint-ok';
                  maintTooltip = t('maint_ok');
                } else if (u.maintenance_status === 'no_maintenance') {
                  maintIcon = 'üü†';
                  maintClass = 'maint-no-maintenance';
                  maintTooltip = t('maint_no_maintenance');
                } else if (u.maintenance_status === 'no_standard') {
                  maintIcon = 'üî¥';
                  maintClass = 'maint-no-standard';
                  maintTooltip = t('maint_no_standard');
                }
                
                // Build version info with app version only (feature version already shown in header)
                const appVersion = u.app_version || u.version || null;
                const versionInfo = appVersion ? `üíª v${appVersion}` : t('version_unknown');
                
                const maintIconHtml = maintIcon ? `<span class="maint-icon ${maintClass}" title="${maintTooltip}">${maintIcon}</span>` : '';
                
                // Apply duplicate styling
                const duplicateStyle = isDuplicate ? ' style="color: red; font-weight: bold;"' : '';
                
                usersHtml += `<div class="user-line" style="margin-left: 16px;">${maintIconHtml}<span${duplicateStyle}>${u.user} @ ${u.computer} ‚Äî ${versionInfo} ‚Äî ${u.start}</span></div>`;
              }
            }
          } else {
            usersHtml = `<div class='small'>${t('no_users')}</div>`;
          }

          html += `<tr class="group-content group-${groupId} ${isCollapsed ? 'collapsed' : ''}">
                    <td><strong>${name}</strong></td>
                    <td>${usage}</td>
                    <td class="versions">${versionsHtml}</td>
                    <td class="users">${usersHtml}</td>
                  </tr>`;
        }
        
      }
    }

    tbody.innerHTML = html;
    lastDiv.textContent = t('last_update', {when: new Date(data.last_update*1000).toLocaleString()});
  } catch (e) {
    document.getElementById("tbody").innerHTML = `<tr><td colspan='4'>${t('fetch_error')}</td></tr>`;
     document.getElementById("error").textContent = e.toString();
  }
}

async function doRefresh(){
  if(refreshing) return;
  refreshing = true;
  btnRefresh.disabled = true;
  btnRefreshLabel.textContent = t('loading');
  try{
    const r = await fetch(refreshUrl, {method: 'POST'});
    if(r.ok){
      showToast(t('refresh_done'));
      await fetchStatus();
    } else {
      showToast(t('refresh_error', {err: 'HTTP ' + r.status}));
    }
  } catch(e){
    showToast(t('fetch_error'));
  } finally{
    refreshing = false;
    btnRefresh.disabled = false;
    btnRefreshLabel.textContent = t('refresh_label');
  }
}

async function doRestart(){
  if(!confirm(t('confirm_restart'))) return;
  if(btnRestart) btnRestart.disabled = true;
  try{
    const r = await fetch(restartUrl, {method: 'POST'});
    const payload = await r.json().catch(()=>null);
    if(r.ok && payload && payload.status === "ok"){
      showToast(t('restart_success'));
      // no auto-refresh or service-msg UI; user can manual refresh
    } else {
      let msg = (payload && payload.message) ? payload.message : ('HTTP ' + r.status);
      showToast(t('restart_error', {err: msg}));
    }
  } catch(e){
    showToast(t('fetch_error'));
  } finally{
    if(btnRestart) btnRestart.disabled = false;
  }
}

async function doRefreshEid(){
  if(refreshingEid) return;
  refreshingEid = true;
  btnRefreshEid.disabled = true;
  btnRefreshEidLabel.textContent = t('loading');
  try{
    // Refresh both EID and license versions in parallel
    const [rEid, rVersions] = await Promise.all([
      fetch(refreshEidUrl, {method: 'POST'}),
      fetch(refreshLicenseVersionsUrl, {method: 'POST'})
    ]);
    
    const dataEid = await rEid.json().catch(()=>null);
    const dataVersions = await rVersions.json().catch(()=>null);
    
    const eidOk = rEid.ok && dataEid && dataEid.ok;
    const versionsOk = rVersions.ok && dataVersions && dataVersions.ok;
    
    if(eidOk && versionsOk){
      showToast(t('eid_refresh_success'));
      await fetchStatus(); // Refresh to show updated data
    } else {
      let errors = [];
      if(!eidOk) {
        const err = (dataEid && dataEid.error) ? dataEid.error : ('HTTP ' + rEid.status);
        errors.push(`EID: ${err}`);
      }
      if(!versionsOk) {
        const err = (dataVersions && dataVersions.error) ? dataVersions.error : ('HTTP ' + rVersions.status);
        errors.push(`Versions: ${err}`);
      }
      showToast(errors.join('\n'));
    }
  } catch(e){
    showToast(t('fetch_error'));
  } finally{
    refreshingEid = false;
    btnRefreshEid.disabled = false;
    btnRefreshEidLabel.textContent = t('refresh_eid_label');
  }
}

btnRefresh.addEventListener("click", doRefresh);
if(btnRestart) btnRestart.addEventListener("click", doRestart);
if(btnRefreshEid) btnRefreshEid.addEventListener("click", doRefreshEid);

// initial
fetchStatus();
// auto refresh
setInterval(fetchStatus, REFRESH_MS);
</script>
</body>
</html>
